;インストールしたAlpine LinuxにSSHログインができるように設定・Dockerのインストールを行う

;環境変数を展開して設定を反映
expandenv host "localhost:%QEMU_SERIAL_PORT% /nossh /T=1"
expandenv shellscript "%SCRIPTDIR%\setup.sh"

;プロンプト
prompt = "localhost:~#"

;念のため10秒待つ
pause 10

;接続
connect host

;ログインプロンプトの表示を待つ
wait "localhost login:"

;rootでログイン
sendln "root"

wait prompt

;セットアップ用のシェルスクリプトをローカルから読み込んでcatコマンドでリモートに書き込み
fileopen fh shellscript 0

sendln "cat << EOF > setup.sh"

while 1
    filereadln fh buf
    if result == 1 then
        break
    endif
    sendln buf
endwhile

sendln "EOF"

fileclose fh

wait prompt

;シェルスクリプト実行
sendln "sh setup.sh"

wait prompt

;シェルスクリプト削除
sendln "rm setup.sh"

wait prompt

;セットアップが終わったのでシャットダウン
sendln "poweroff"

;Telnet切断 = Qemu終了まで待つ
waitevent 4