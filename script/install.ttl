;Alpine Linuxのインストールを行う

;環境変数を展開して設定を反映
expandenv host "localhost:%QEMU_SERIAL_PORT% /nossh /T=1"
expandenv answerfile "%SCRIPTDIR%\answerfile"

;プロンプト
prompt = "localhost:~#"

;念のため10秒待つ
pause 10

;接続
connect host

wait "localhost login:"

;rootでログイン
sendln "root"

wait prompt

;ローカルのanswerfileを読み込んでcatコマンドでリモートに書き込み
fileopen fh answerfile 0

sendln "cat << EOF > answerfile"

while 1
    filereadln fh buf
    if result=1 then
        break
    endif
    sendln buf
endwhile

sendln "EOF"

fileclose fh

wait prompt

;alpineのsetupスクリプトを起動
sendln "setup-alpine -e -f answerfile"

;書き込みOKの入力待ちは省略できないっぽいのでマクロで入力
wait "continue? [y/N]:"

sendln "y"

wait prompt

;インストールが終了したのでシャットダウン
sendln "poweroff"

;Telnet切断 = Qemu終了まで待つ
waitevent 4